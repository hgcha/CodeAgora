<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8"/>
        <link rel="stylesheet" href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}"/>
        <title>CodeAgora</title>
    </head>
    <body>
        <nav th:replace="~{navbar :: nav}"></nav>

        <div style="width: 50%; margin: 0 auto;">
            <!--게시글-->
            <div class="card mt-5">
                <div class="card-body">
                    <h4 class="card-title mb-3" th:text="${post.title}">
                        게시글 제목
                    </h4>
                    <p>
                        <span th:text="${post.author} == null ? 'null' : ${post.author.username}">작성자 ID</span>
                        <span style="float: right;" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm:ss')}">작성 시간</span>
                    </p>
                    <hr/>
                    <p class="card-text mt-4" th:text="${post.content}">
                        게시글 내용
                    </p>
                </div>
            </div>

            <!--글 수정 버튼-->
            <div class="mt-3 mb-5 d-flex flex-row-reverse" style="gap: 10px;">
                <form th:action="@{|/infoBoard/${post.id}/delete|}" method="post">
                    <button class="btn btn-primary" type="submit">
                        삭제
                    </button>
                </form>

                <button class="btn btn-primary" type="button" th:onclick="|location.href='/infoBoard/${post.id}/update'|">
                    수정
                </button>
            </div>

            <!--댓글-->
            <div class="card mb-2 w-100" th:each="comment : ${post.comments}">
                <div class="card-body">
                    <p class="m-0">
                        <span class="card-text" th:text="${comment.author} != null ? 'comment.author.username' : 'null'">댓글 작성자 이름</span>
                        <span class="card-text" style="float: right;" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm:ss')}">댓글 작성 시간</span>
                    </p>

                    <!--수정, 삭제 버튼-->
                    <div class="d-flex flex-row-reverse" style="gap: 5px;">
                        <form th:action="@{|/infoBoard/${post.id}/comments/${comment.id}/delete|}" method="post">
                            <button class="btn btn-primary btn-sm mt-2" type="submit">
                                삭제
                            </button>
                        </form>

                        <button class="btn btn-primary btn-sm mt-2" type="button" th:onclick="|showCommentUpdate(${comment.id})|">
                            수정
                        </button>
                    </div>

                    <hr/>

                    <!-- 댓글 내용 -->
                    <p th:id="|commentContent${comment.id}|"
                       th:style="${commentUpdateDto != null} ? (${commentUpdateDto.id} == ${comment.id} and ${#fields.hasErrors('${commentUpdateDto.content}')} ? 'display: none;')"
                       class="card-text mt-4" th:text="${comment.content}">댓글 내용</p>

                    <!-- 댓글 수정 창 -->
                    <form th:id="|commentUpdate${comment.id}|"
                          th:style="${commentUpdateDto == null} ? 'display: none;' : (${commentUpdateDto.id} == ${comment.id} and ${#fields.hasErrors('${commentUpdateDto.content}')} ? 'display: block;' : 'display: none;')"
                          th:action="@{|/infoBoard/${post.id}/comments/${comment.id}/update|}"
                          method="post">
                        <input type="hidden" name="id" th:value="${comment.id}"/>
                        <textarea class="w-100 form-control"
                                  style="resize: none;"
                                  rows="3"
                                  name="content"
                                  th:text="${commentUpdateDto?.content} ?: ${comment.content}"
                                  th:classappend="${commentUpdateDto != null} ? (${commentUpdateDto.id} == ${comment.id} and ${#fields.hasErrors('${commentUpdateDto.content}')} ? 'is-invalid')" >
                        </textarea>
                        <p class="invalid-feedback">
                            빈 댓글은 입력할 수 없습니다.
                        </p>
                        <button type="submit" class="btn btn-primary btn-sm mt-2">
                            수정
                        </button>
                        <button type="button" class="btn btn-primary btn-sm mt-2" th:onclick="|hideCommentUpdate(${comment.id})|">
                            취소
                        </button>
                    </form>

                </div>
            </div>

            <!--댓글 입력-->
            <form class="mt-5 w-100" th:object="${comment}" th:action="@{|/infoBoard/${post.id}/comments|}" method="post">
                <input type="hidden" th:value="${post.id}"/>
                <textarea class="w-100 form-control" th:errorclass="is-invalid" th:field="*{content}" style="resize: none;" rows="3" placeholder="댓글을 입력해주세요."></textarea>
                <p class="invalid-feedback" th:if="${#fields.hasErrors('content')}" th:errors="*{content}">
                    빈 댓글은 작성할 수 없습니다.
                </p>
                <button class="btn btn-primary float-end mt-2" type="submit">댓글 작성</button>
            </form>

        </div>

        <script>
            function showCommentUpdate(id) {
                document.getElementById('commentContent' + id).style.display = 'none';
                document.getElementById('commentUpdate' + id).style.display = 'block';
            }

            function hideCommentUpdate(id) {
                document.getElementById('commentContent' + id).style.display = 'block';
                document.getElementById('commentUpdate' + id).style.display = 'none';
            }
        </script>
    </body>
</html>
